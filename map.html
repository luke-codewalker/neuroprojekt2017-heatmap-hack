<!-- Styles for positioning canvas over map -->
<style type="text/css">
    canvas {
        border: 2px solid black;
    }

    #map-wrapper {
        position: relative;
    }

    #bg-img {
        width: 100%;
        height: auto;
    }

    #map {
        position: absolute;
        top: 0;
        left: 0;
    }

    .error-msg {
        display: none;
        background-color: rgba(255, 0, 0, 0.5)
    }
</style>

<!-- Instructions -->
<section id="instructions">
    <h2> Top 5 Stationen</h2>
    <p> Bitte markiere auf diesem Netzplan die 5 Stationen, die du am häufigsten nutzt. Beginne dabei mit der von dir am häufigsten
        genutzten Station und markieren dann die weiteren Stationen in absteigender Reihenfolge.
    </p>
    <p> Um eine Station zu markieren, musst du nur mit der linken Maustaste auf die Karte klicken. Zum Löschen einzelner oder
        aller Markierungen verwende bitte die Buttons.
    </p>
    <p> Zum Abschluss klicke einfach auf "Weiter" unten auf der Seite.
    </p>
    <input type="button" id="del-all" value="Alle Einträge löschen">
    <input type="button" id="del-last" value="Letzten Eintrag löschen">
    </p>
</section>

<!-- Heatmap Canvas and Code -->
<section id="heatmap">
    <div class="error-msg">
        <p>Leider funktioniert die Karte nicht. Bitte klicke auf "Weiter". Du wirst vor dem Versuch noch eine weitere Gelegenheit
            haben, die Frage auszufüllen.</p>
    </div>
    <div id="map-wrapper">
        <!-- Make sure the image you want use is accessible under that src! -->
        <img id="bg-img" src="test-map.png">
        <canvas id="map" width="10" height="10">
            Diese Frage funktioniert leider aus technischen Gründen in deinem Browser nicht, da JavaScript nicht aktiviert ist, bzw.
            dein Browser das HTML5 "canvas"-Element nicht unterstützt. Bitte klicke auf "Weiter". Du wirst vor dem Versuch
            noch eine weitere Gelegenheit haben, die Frage auszufüllen.
        </canvas>
    </div>

    <script type="text/javascript">
        // Custom heatmap module
        const Heatmap = (function () {
            let canvas;
            let ctx;
            let img;
            let points = [];
            let size = {
                width: 0,
                height: 0
            }

            const setSize = function (width, height) {
                size.width = width;
                size.height = height;
                canvas.width = size.width;
                canvas.height = size.height;
            }

            return {
                initialize: function (_canvas, _img) {
                    canvas = _canvas;
                    img = _img;
                    setSize(img.clientWidth, img.clientHeight);

                    if (!window.CanvasRenderingContext2D) {
                        img.style.opacity = 0.2;
                        return console.error('[ Heatmap Error ] No canvas rendering context.');
                    }
                    ctx = canvas.getContext('2d');
                },

                setSize: setSize,

                getSize: function () {
                    return size;
                },

                addPoint: function (_x, _y) {
                    points.push({ x: _x, y: _y });
                },

                removeLastPoint: function () {
                    points.pop();
                },

                removeAllPoints: function () {
                    points = [];
                },

                getPoints: function () {
                    return points;
                },

                renderPoints: function () {
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    for (let i = 0; i < points.length; i++) {
                        const point = points[i];

                        let size = Math.floor(canvas.width / 20) - i * Math.floor(canvas.width / 100);
                        if (size <= 10) size = 10;

                        ctx.beginPath();
                        ctx.fillStyle = 'rgba(255,200,0,0.75)';
                        ctx.strokeStyle = 'rgb(255,0,0)';
                        ctx.lineWidth = 3;
                        if ('ellipse' in ctx) {
                            ctx.ellipse(point.x, point.y, size, size, 0, 0, 2 * Math.PI);
                        } else {
                            ctx.rect(point.x, point.y, size, size);
                        }
                        ctx.stroke();
                        ctx.fill();
                    }
                },
            }
        })()

        const img = document.getElementById('bg-img');
        const canvas = document.getElementById('map');

        Heatmap.initialize(canvas, img);

        canvas.addEventListener('click', function (e) {
            Heatmap.addPoint(e.offsetX, e.offsetY);
            Heatmap.renderPoints();
        })

        document.getElementById('del-all')
            .addEventListener('click', function () {
                Heatmap.removeAllPoints();
                Heatmap.renderPoints();
            });

        document.getElementById('del-last')
            .addEventListener('click', function () {
                Heatmap.removeLastPoint();
                Heatmap.renderPoints();
            });
    </script>
</section>